# Publish to Domo when code is pushed to main
name: Publish to Domo

on:
  push:
    branches: [main]
  workflow_dispatch:

jobs:
  publish:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: "20"

      - name: Install Domo CLI (ryuu)
        run: |
          npm cache clean --force
          npm install -g ryuu --prefer-online --no-audit --no-fund || \
          npm install -g ryuu --registry https://registry.npmmirror.com --prefer-online --no-audit --no-fund

      - name: Fix ryuu inquirer dependency
        run: cd $(npm root -g)/ryuu && npm install inquirer --save || true

      - name: Login to Domo
        env:
          DOMO_INSTANCE: ${{ secrets.DOMO_INSTANCE || 'stoagroup.domo.com' }}
          DOMO_TOKEN: ${{ secrets.DOMO_TOKEN }}
          DOMO_ACCESS_TOKEN: ${{ secrets.DOMO_ACCESS_TOKEN }}
        run: |
          # Use Access Token (Admin → Access Tokens) or DOMO_TOKEN. API/client credentials are different.
          TOKEN="${DOMO_ACCESS_TOKEN:-$DOMO_TOKEN}"
          if [ -z "$TOKEN" ]; then
            echo "::error::Set DOMO_ACCESS_TOKEN or DOMO_TOKEN (Admin → Access Tokens)."
            exit 1
          fi
          echo "Using access token..."
          domo login -i "$DOMO_INSTANCE" -t "$TOKEN"

      - name: Publish to Domo
        run: domo publish
        working-directory: .
