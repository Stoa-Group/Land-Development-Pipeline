<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Banking Dashboard | Stoa Group</title>
  <link rel="stylesheet" href="app.css" />
</head>
<body>
  <!-- Header with Stoa Branding -->
  <header class="topbar">
    <div class="topbar-left">
      <img src="Logos/StoaGroup_Stacked_Logo_Color.png" alt="Stoa Group" class="logo" />
      <div>
        <h1>Banking Dashboard</h1>
        <div class="subtle">Real-time financial insights</div>
      </div>
    </div>

    <div class="controls">
      <!-- Edit Mode Button -->
      <button id="editModeBtn" class="btn btn-secondary" style="margin-right: 12px;">
        <span id="editModeBtnText">Edit Mode</span>
      </button>
      
      <!-- Deal Pipeline Button (Admin Only) -->
      <button id="dealPipelineBtn" class="btn btn-secondary admin-only" style="margin-right: 12px; display: none;">
        <span>Deal Pipeline</span>
      </button>
      
      <!-- Custom multiselect: STATUS/STAGE -->
      <div class="multi" id="statusMulti" aria-label="Filter by status/stage" data-type="status">
        <button class="multi-btn" type="button" aria-expanded="false">
          <span class="multi-label">All Statuses</span>
          <i class="car"></i>
        </button>
        <div class="multi-menu" role="menu" aria-hidden="true">
          <div class="multi-actions">
            <button type="button" data-act="all">Select all</button>
            <button type="button" data-act="none">Clear</button>
          </div>
          <div class="multi-list" role="group"></div>
        </div>
      </div>

      <input id="q" class="search" type="search" placeholder="Search…" />
      <button id="refreshBtn" class="btn btn-icon" aria-label="Refresh data">
        <svg width="16" height="16" viewBox="0 0 16 16" fill="none"><path d="M8 2v4l2-2M8 14v-4l2 2M2 8h4l-2-2M14 8h-4l2 2" stroke="currentColor" stroke-width="1.5" stroke-linecap="round"/></svg>
      </button>
    </div>
  </header>

  <!-- Loading Overlay -->
  <div id="loadingOverlay" class="loading-overlay" style="display: none;">
    <div class="loading-content">
      <div class="loading-spinner"></div>
      <h2>Loading Dashboard Data</h2>
      <div class="loading-progress-container">
        <div class="loading-progress-bar">
          <div class="loading-progress-fill" id="loadingProgressFill"></div>
        </div>
        <div class="loading-progress-text" id="loadingProgressText">0%</div>
      </div>
      <p class="loading-status" id="loadingStatus">Initializing...</p>
    </div>
  </div>

  <main class="page">
    <!-- Main Tab Navigation -->
    <nav class="main-tabs" role="tablist">
      <button class="main-tab active" data-tab="by-property" role="tab">
        <span>By Property</span>
      </button>
      <button class="main-tab" data-tab="by-bank" role="tab">
        <span>Search by Bank</span>
      </button>
      <button class="main-tab" data-tab="by-equity" role="tab">
        <span>Search by Equity</span>
      </button>
      <button class="main-tab" data-tab="contacts-partners" role="tab">
        <span>Contacts & Partners</span>
      </button>
    </nav>

    <!-- By Property View -->
    <section id="view-by-property" class="view active">
      <!-- View Switcher (Construction / Permanent / Equity) -->
      <div class="view-switcher">
        <button class="view-switch active" data-view="construction">
          <span>Construction Financing</span>
        </button>
        <button class="view-switch" data-view="permanent">
          <span>Permanent Financing</span>
        </button>
        <button class="view-switch" data-view="equity">
          <span>Equity</span>
        </button>
      </div>

      <!-- Dynamic KPIs based on selected view -->
      <section class="kpi-grid" id="kpiGrid" aria-label="key metrics">
        <!-- KPIs will be dynamically generated -->
      </section>

      <!-- Properties Table -->
      <section class="panel">
        <div class="panel-head">
          <div class="panel-title">Properties</div>
          <div class="inline-controls">
            <span id="resultCount" class="badge">0 results</span>
            <button id="expandAllBtn" class="btn btn-sm">Expand All</button>
          </div>
        </div>

        <div class="table-wrap">
          <table class="table" id="propertiesTable" aria-label="properties list">
            <thead id="listHead">
              <!-- Headers will be dynamically generated -->
            </thead>
            <tbody id="listBody">
              <tr><td class="empty" colspan="10">Loading…</td></tr>
            </tbody>
            <tfoot id="listFoot">
              <!-- Footer headers will be dynamically generated -->
            </tfoot>
          </table>
        </div>
      </section>
    </section>

    <!-- Search by Bank View -->
    <section id="view-by-bank" class="view">
      <section class="panel">
        <div class="panel-head">
          <div class="panel-title">Banks & Exposure</div>
          <div class="inline-controls">
            <span id="bankResultCount" class="badge">0 banks</span>
            <button id="collapseAllBanksBtn" class="btn btn-sm">Collapse All</button>
          </div>
        </div>

        <div class="table-wrap">
          <table class="table" id="banksTable" aria-label="banks list">
            <thead>
              <tr>
                <th class="th-sort" data-key="BankName" title="Bank Name">Bank Name <i class="sort"></i></th>
                <th class="th-sort num" data-key="DealCount" title="Number of Deals">Number of Deals <i class="sort"></i></th>
                <th class="th-sort num" data-key="Exposure" title="Total exposure across all deals for this bank">Exposure <i class="sort"></i></th>
                <th class="th-sort" data-key="Positioning" title="Positioning">Positioning <i class="sort"></i></th>
                <th class="th-sort num" data-key="EstimatedHoldLimit" title="Estimated Hold Limit">Est. Hold Limit <i class="sort"></i></th>
                <th class="th-sort num" data-key="EstimatedCapacity" title="Estimated Capacity">Est. Capacity <i class="sort"></i></th>
                <th class="th-sort num" data-key="DebtYield" title="Debt Yield">Debt Yield <i class="sort"></i></th>
                <th class="th-sort num" data-key="LastDollar" title="Last Dollar">Last Dollar <i class="sort"></i></th>
                <th class="th-sort num" data-key="LTC" title="LTC">LTC <i class="sort"></i></th>
              </tr>
            </thead>
            <tbody id="banksBody">
              <tr><td class="empty" colspan="9">Loading…</td></tr>
            </tbody>
          </table>
        </div>
      </section>
    </section>

    <!-- Search by Equity View -->
    <section id="view-by-equity" class="view">
      <!-- Dynamic KPIs for Equity View -->
      <section class="kpi-grid" id="equityKpiGrid" aria-label="equity metrics">
        <!-- KPIs will be dynamically generated -->
      </section>

      <section class="panel">
        <div class="panel-head">
          <div class="panel-title">Investors & Equity</div>
          <div class="inline-controls">
            <span id="equityResultCount" class="badge">0 investors</span>
          </div>
        </div>

        <div class="table-wrap">
          <table class="table" id="equityTable" aria-label="equity deals list">
            <thead>
              <tr>
                <th class="th-sort" data-key="InvestorName" title="Investor Name">Investor Name <i class="sort"></i></th>
                <th class="th-sort num" data-key="DealCount" title="Number of Deals">Number of Deals <i class="sort"></i></th>
                <th class="th-sort num" data-key="Exposure" title="Total Exposure">Total Exposure <i class="sort"></i></th>
                <th class="th-sort num" data-key="LastDollar" title="Last Dollar">Last Dollar <i class="sort"></i></th>
                <th class="th-sort num" data-key="LTC" title="LTC">LTC <i class="sort"></i></th>
              </tr>
            </thead>
            <tbody id="equityBody">
              <tr><td class="empty" colspan="5">Loading…</td></tr>
            </tbody>
          </table>
        </div>
      </section>
    </section>

    <!-- Contacts & Partners View -->
    <section id="view-contacts-partners" class="view">
      <section class="panel">
        <div class="panel-head">
          <div class="panel-title">Contacts & Partners Management</div>
          <div class="inline-controls">
            <span id="contactsPartnersResultCount" class="badge">0 partners</span>
          </div>
        </div>

        <div class="table-wrap">
          <table class="table" id="contactsPartnersTable" aria-label="contacts and partners list">
            <thead>
              <tr>
                <th class="th-sort" data-key="PartnerName" title="Partner/LLC Name">Partner/LLC Name <i class="sort"></i></th>
                <th class="th-sort" data-key="PartnerType" title="Type">Type <i class="sort"></i></th>
                <th title="Investor Rep">Investor Rep</th>
                <th title="Related Parties">Related Parties</th>
                <th class="th-sort num" data-key="CommitmentCount" title="Commitments">Commitments <i class="sort"></i></th>
                <th title="Actions">Actions</th>
              </tr>
            </thead>
            <tbody id="contactsPartnersBody">
              <tr><td class="empty" colspan="6">Loading…</td></tr>
            </tbody>
          </table>
        </div>
      </section>
    </section>

    <!-- Deal Pipeline View (Admin Only) -->
    <section id="view-deal-pipeline" class="view admin-only" style="display: none;">
      <div class="deal-pipeline-header" style="background: linear-gradient(135deg, #ff6b6b 0%, #ee5a6f 100%); color: white; padding: 24px; border-radius: var(--radius); margin-bottom: 24px; box-shadow: 0 4px 12px rgba(0,0,0,0.1);">
        <div style="display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 12px;">
          <div style="flex: 1;">
            <h2 style="margin: 0 0 8px 0; font-size: 24px; font-weight: 700;">⚠️ Deal Pipeline - Core Data Management</h2>
            <p style="margin: 0; opacity: 0.95; font-size: 14px;">
              <strong>Admin Access Only:</strong> Changes made here affect deal attributes across ALL departments. 
              Please validate all changes carefully before saving.
            </p>
          </div>
          <button id="exitDealPipelineBtn" class="btn" style="background: white; color: #ff6b6b; border: 2px solid white; margin-left: 16px; white-space: nowrap;">
            ← Back to Dashboard
          </button>
        </div>
      </div>
      
      <!-- Deal Pipeline Tabs -->
      <!-- Tabs removed - only Deal Attributes view now -->
      
      <!-- Deal Attributes Tab -->
      <div id="deal-pipeline-deals-tab" class="deal-pipeline-tab-content">
      <section class="panel">
        <div class="panel-head">
          <div class="panel-title">Core Deal Attributes</div>
          <div class="inline-controls">
            <button id="addDealBtn" class="btn btn-sm" onclick="showAddDealModal()" style="margin-right: 12px;">+ Add Deal</button>
            <span id="dealPipelineResultCount" class="badge">0 deals</span>
          </div>
        </div>
        <div class="panel-body">
          <!-- Search Filter -->
          <div style="margin-bottom: 16px;">
            <input type="text" 
                   id="dealPipelineSearch" 
                   class="form-input" 
                   placeholder="Search deals by name, city, state, region, product type, or stage..." 
                   style="width: 100%; max-width: 500px;"
                   autocomplete="off" />
          </div>
          <div id="dealPipelineTableContainer">
            <!-- Deal Pipeline table will be rendered here -->
          </div>
        </div>
      </section>
    </section>
  </main>

  <!-- Confirmation Modal -->
  <div id="confirmModal" class="modal" style="display: none;">
    <div class="modal-content">
      <h3>Confirm Save</h3>
      <p>Are you sure you want to save these changes?</p>
      <div class="modal-actions">
        <button id="confirmSaveBtn" class="btn">Save</button>
        <button id="cancelSaveBtn" class="btn btn-secondary">Cancel</button>
      </div>
    </div>
  </div>

  <!-- Add/Edit Equity Commitment Modal -->
  <div id="addEquityCommitmentModal" class="modal" style="display: none;">
    <div class="modal-content">
      <h3 id="equityModalTitle">Add Equity Commitment</h3>
      <form id="equityCommitmentForm">
        <div class="form-group">
          <label for="equityProjectSelect">Deal/Property *</label>
          <select id="equityProjectSelect" class="form-input" required>
            <option value="">-- Select Deal --</option>
          </select>
        </div>
        <div class="form-group">
          <label for="equityPartnerSelect">Equity Partner *</label>
          <select id="equityPartnerSelect" class="form-input" required>
            <option value="">-- Select Partner --</option>
          </select>
          <button type="button" id="createNewPartnerBtn" class="btn btn-sm" style="margin-top: 8px;">+ Create New Partner</button>
        </div>
        <div id="newPartnerFields" style="display: none;">
          <div class="form-group">
            <label for="newPartnerName">Partner Name *</label>
            <input type="text" id="newPartnerName" class="form-input" />
          </div>
          <div class="form-group">
            <label for="newPartnerType">Partner Type *</label>
            <select id="newPartnerType" class="form-input" required>
              <option value="Entity">Entity</option>
              <option value="Individual">Individual</option>
            </select>
          </div>
          <div class="form-group" id="newPartnerRepGroup">
            <label for="newPartnerRepSelect">Investor Rep (Contact)</label>
            <select id="newPartnerRepSelect" class="form-input">
              <option value="">-- Select Existing Contact or Create New --</option>
              <option value="__new__">+ Create New Contact</option>
            </select>
          </div>
          <div id="newPartnerRepFields" style="display: none;">
            <div class="form-group">
              <label for="newPartnerRepName">Contact Name *</label>
              <input type="text" id="newPartnerRepName" class="form-input" placeholder="e.g., John Doe" />
            </div>
            <div class="form-group">
              <label for="newPartnerRepEmail">Contact Email</label>
              <input type="email" id="newPartnerRepEmail" class="form-input" placeholder="e.g., john@abccapital.com" />
            </div>
            <div class="form-group">
              <label for="newPartnerRepPhone">Contact Phone</label>
              <input type="tel" id="newPartnerRepPhone" class="form-input" placeholder="e.g., 555-1234" />
            </div>
          </div>
        </div>
        <div class="form-group">
          <label for="equityRelatedParties">Related Parties</label>
          <div id="equityRelatedPartiesContainer" class="searchable-select">
            <div id="equityRelatedPartiesChips" style="display: flex; flex-wrap: wrap; gap: 6px; margin-bottom: 8px; min-height: 32px;">
              <!-- Selected items will appear as chips here -->
            </div>
            <input type="text" id="equityRelatedPartiesSearch" class="form-input" placeholder="Search for related parties..." autocomplete="off" />
            <select id="equityRelatedParties" class="form-input" multiple style="display: none;">
              <!-- Hidden select for form submission -->
            </select>
            <div id="equityRelatedPartiesDropdown" class="searchable-dropdown" style="display: none; max-height: 200px; overflow-y: auto;"></div>
            <small style="color: var(--muted); display: block; margin-top: 4px;">Select other investors involved in this commitment (not the lead)</small>
          </div>
        </div>
        <div class="form-group">
          <label for="equityType">Equity Type</label>
          <select id="equityType" class="form-input">
            <option value="">-- Select Type --</option>
            <option value="Pref">Pref</option>
            <option value="Common">Common</option>
            <option value="Profits Interest">Profits Interest</option>
            <option value="Stoa Loan">Stoa Loan</option>
            <option value="Other">Other</option>
          </select>
        </div>
        <div class="form-group">
          <label for="equityAmount">Amount *</label>
          <input type="number" id="equityAmount" class="form-input" step="0.01" required />
        </div>
        <div class="form-group">
          <label for="equityFundingDate">Funding Date</label>
          <input type="date" id="equityFundingDate" class="form-input" />
        </div>
        <div class="modal-actions">
          <button type="submit" class="btn">Save</button>
          <button type="button" id="cancelEquityModalBtn" class="btn btn-secondary">Cancel</button>
        </div>
      </form>
    </div>
  </div>

  <!-- Edit Equity Partner Modal -->
  <div id="editEquityPartnerModal" class="modal" style="display: none;">
    <div class="modal-content">
      <h3 id="editPartnerModalTitle">Edit Equity Partner</h3>
      <form id="editEquityPartnerForm">
        <input type="hidden" id="editPartnerId" />
        <div class="form-group">
          <label for="editPartnerName">Partner Name *</label>
          <input type="text" id="editPartnerName" class="form-input" required />
        </div>
        <div class="form-group">
          <label for="editPartnerType">Partner Type *</label>
          <select id="editPartnerType" class="form-input" required>
            <option value="Entity">Entity</option>
            <option value="Individual">Individual</option>
          </select>
        </div>
        <div class="form-group" id="editPartnerRepGroup">
          <label for="editPartnerRepSelect">Investor Rep (Contact)</label>
          <div class="searchable-select">
            <input type="text" id="editPartnerRepSearch" class="form-input" placeholder="Search for contact..." autocomplete="off" />
            <select id="editPartnerRepSelect" class="form-input" style="display: none;">
              <!-- Hidden select for form submission -->
            </select>
            <div id="editPartnerRepDropdown" class="searchable-dropdown" style="display: none; max-height: 200px; overflow-y: auto;"></div>
          </div>
        </div>
        <div id="editPartnerRepFields" style="display: none;">
          <div class="form-group">
            <label for="editPartnerRepName">Contact Name *</label>
            <input type="text" id="editPartnerRepName" class="form-input" placeholder="e.g., John Doe" />
          </div>
          <div class="form-group">
            <label for="editPartnerRepEmail">Contact Email</label>
            <input type="email" id="editPartnerRepEmail" class="form-input" placeholder="e.g., john@abccapital.com" />
          </div>
          <div class="form-group">
            <label for="editPartnerRepPhone">Contact Phone</label>
            <input type="tel" id="editPartnerRepPhone" class="form-input" placeholder="e.g., 555-1234" />
          </div>
        </div>
        <div class="modal-actions">
          <button type="submit" class="btn">Save</button>
          <button type="button" id="cancelEditPartnerModalBtn" class="btn btn-secondary">Cancel</button>
        </div>
      </form>
    </div>
  </div>

  <!-- Add Permanent Financing Modal -->
  <div id="addPermanentFinancingModal" class="modal" style="display: none;">
    <div class="modal-content" style="max-width: 600px;">
      <h3 id="permanentModalTitle">Add Permanent Financing</h3>
      <form id="permanentFinancingForm">
        <div class="form-group">
          <label for="permanentProjectSelect">Property/Deal *</label>
          <select id="permanentProjectSelect" class="form-input" required>
            <option value="">-- Select Property --</option>
          </select>
        </div>
        <div class="form-group">
          <label for="permanentLenderSelect">Lender/Bank *</label>
          <div class="searchable-select">
            <input type="text" id="permanentLenderSearch" class="form-input" placeholder="Search banks..." autocomplete="off" />
            <select id="permanentLenderSelect" class="form-input" required style="display: none;">
              <option value="">-- Select Lender --</option>
            </select>
            <div id="permanentLenderDropdown" class="searchable-dropdown" style="display: none;"></div>
          </div>
        </div>
        <div class="form-group">
          <label for="permanentCloseDate">Permanent Close Date *</label>
          <input type="date" id="permanentCloseDate" class="form-input" required />
        </div>
        <div class="form-group">
          <label for="permanentLoanAmount">Permanent Loan Amount *</label>
          <input type="number" id="permanentLoanAmount" class="form-input" step="0.01" min="0" required />
        </div>
        <div class="form-group">
          <label for="permanentMaturityDate">Maturity Date (Perm Phase Maturity) *</label>
          <input type="date" id="permanentMaturityDate" class="form-input" required />
        </div>
        <div class="form-group">
          <label for="permanentInterestRate">Permanent Interest Rate</label>
          <input type="text" id="permanentInterestRate" class="form-input" placeholder="e.g., 5.5%" />
        </div>
        <div class="form-group">
          <label for="permanentFixedOrFloating">Fixed or Floating</label>
          <select id="permanentFixedOrFloating" class="form-input">
            <option value="">-- Select --</option>
            <option value="Fixed">Fixed</option>
            <option value="Floating">Floating</option>
          </select>
        </div>
        <div class="form-group">
          <label for="permanentIndexName">Index Name</label>
          <select id="permanentIndexName" class="form-input">
            <option value="">-- Select --</option>
            <option value="Prime">Prime</option>
            <option value="SOFR">SOFR</option>
          </select>
        </div>
        <div class="form-group">
          <label for="permanentSpread">Spread</label>
          <input type="number" id="permanentSpread" class="form-input" step="0.01" placeholder="e.g., 2.75" />
        </div>
        <div class="modal-actions">
          <button type="submit" class="btn">Save Permanent Financing</button>
          <button type="button" id="cancelPermanentModalBtn" class="btn btn-secondary">Cancel</button>
        </div>
      </form>
    </div>
  </div>

  <!-- Add/Edit Covenant Modal -->
  <div id="addCovenantModal" class="modal" style="display: none;">
    <div class="modal-content" style="max-width: 600px;">
      <h3 id="covenantModalTitle">Add Covenant</h3>
      <form id="covenantForm">
        <!-- Covenant Type Dropdown (REQUIRED) -->
        <div class="form-group">
          <label for="covenantType">Covenant Type *</label>
          <select id="covenantType" class="form-input" required>
            <option value="">-- Select Type --</option>
            <option value="DSCR">DSCR</option>
            <option value="Occupancy">Occupancy</option>
            <option value="Liquidity Requirement">Liquidity Requirement</option>
            <option value="Other">Other</option>
          </select>
        </div>

        <!-- DSCR Fields (hidden by default) -->
        <div id="dscrFields" style="display: none;">
          <div class="form-group">
            <label for="dscrTestDate">DSCR Test Date *</label>
            <input type="date" id="dscrTestDate" class="form-input" />
          </div>
          <div class="form-group">
            <label for="projectedInterestRate">Projected Interest Rate</label>
            <input type="text" id="projectedInterestRate" class="form-input" placeholder="e.g., 5.25%" />
          </div>
          <div class="form-group">
            <label for="dscrRequirement">DSCR Requirement</label>
            <input type="text" id="dscrRequirement" class="form-input" placeholder="e.g., 1.25" />
          </div>
          <div class="form-group">
            <label for="projectedDSCR">Projected DSCR</label>
            <input type="text" id="projectedDSCR" class="form-input" placeholder="e.g., 1.35" />
          </div>
        </div>

        <!-- Occupancy Fields (hidden by default) -->
        <div id="occupancyFields" style="display: none;">
          <div class="form-group">
            <label for="occupancyCovenantDate">Occupancy Covenant Date *</label>
            <input type="date" id="occupancyCovenantDate" class="form-input" />
          </div>
          <div class="form-group">
            <label for="occupancyRequirement">Occupancy Requirement</label>
            <input type="text" id="occupancyRequirement" class="form-input" placeholder="e.g., 50%" />
          </div>
          <div class="form-group">
            <label for="projectedOccupancy">Projected Occupancy %</label>
            <input type="text" id="projectedOccupancy" class="form-input" placeholder="e.g., 76.5%" />
          </div>
        </div>

        <!-- Liquidity Fields (hidden by default) -->
        <div id="liquidityFields" style="display: none;">
          <div class="form-group">
            <label for="liquidityRequirementLendingBank">Liquidity Requirement - Lending Bank</label>
            <input type="number" id="liquidityRequirementLendingBank" class="form-input" step="0.01" min="0" placeholder="e.g., 1000000" />
          </div>
        </div>

        <!-- Other Fields (hidden by default) -->
        <div id="otherFields" style="display: none;">
          <div class="form-group">
            <label for="covenantDate">Covenant Date *</label>
            <input type="date" id="covenantDate" class="form-input" />
          </div>
          <div class="form-group">
            <label for="covenantRequirement">Requirement</label>
            <input type="text" id="covenantRequirement" class="form-input" placeholder="e.g., Minimum 1.25x" />
          </div>
          <div class="form-group">
            <label for="covenantProjected">Projected Value</label>
            <input type="text" id="covenantProjected" class="form-input" placeholder="Projected value" />
          </div>
        </div>

        <!-- Notes (always visible) -->
        <div class="form-group">
          <label for="covenantNotes">Notes</label>
          <textarea id="covenantNotes" class="form-input" rows="3" placeholder="Additional notes..."></textarea>
        </div>

        <div class="modal-actions">
          <button type="submit" class="btn">Save Covenant</button>
          <button type="button" id="cancelCovenantModalBtn" class="btn btn-secondary">Cancel</button>
        </div>
      </form>
    </div>
  </div>

  <!-- Add/Edit Personal Guarantee Modal -->
  <div id="addGuaranteeModal" class="modal" style="display: none;">
    <div class="modal-content" style="max-width: 500px;">
      <h3 id="guaranteeModalTitle">Add Personal Guarantee</h3>
      <form id="guaranteeForm">
        <div class="form-group">
          <label for="guaranteePersonSelect">Person *</label>
          <select id="guaranteePersonSelect" class="form-input" required>
            <option value="">-- Select Person --</option>
          </select>
        </div>
        <div class="form-group">
          <label for="guaranteeAmount">Guarantee Amount *</label>
          <input type="number" id="guaranteeAmount" class="form-input" step="0.01" min="0" required placeholder="e.g., 1000000" />
          <small style="color: var(--muted); display: block; margin-top: 4px;">Guarantee % will be calculated automatically based on the loan amount</small>
        </div>
        <div class="form-group" style="display: none;">
          <label for="guaranteePercent">Guarantee % (Calculated)</label>
          <input type="number" id="guaranteePercent" class="form-input" step="0.01" readonly />
        </div>
        <div class="modal-actions">
          <button type="submit" class="btn">Save Guarantee</button>
          <button type="button" id="cancelGuaranteeModalBtn" class="btn btn-secondary">Cancel</button>
        </div>
      </form>
    </div>
  </div>

  <!-- Add/Edit Participation Modal -->
  <div id="addParticipationModal" class="modal" style="display: none;">
    <div class="modal-content" style="max-width: 500px;">
      <h3 id="participationModalTitle">Add Participation</h3>
      <form id="participationForm">
        <div class="form-group">
          <label for="participationBankSelect">Bank *</label>
          <div class="searchable-select">
            <input type="text" id="participationBankSearch" class="form-input" placeholder="Search banks..." autocomplete="off" />
            <select id="participationBankSelect" class="form-input" style="display: none;">
              <option value="">-- Select Bank --</option>
            </select>
            <div id="participationBankDropdown" class="searchable-dropdown" style="display: none;"></div>
          </div>
        </div>
        <div class="form-group">
          <label for="participationExposure">Exposure Amount *</label>
          <input type="number" id="participationExposure" class="form-input" step="0.01" min="0" required placeholder="e.g., 1000000" />
          <small style="color: var(--muted); display: block; margin-top: 4px;">Participation % will be calculated automatically based on the loan amount</small>
        </div>
        <div class="form-group" style="display: none;">
          <label for="participationPercent">Participation % (Calculated)</label>
          <input type="number" id="participationPercent" class="form-input" step="0.01" readonly />
        </div>
        <div class="form-group">
          <label for="participationFinancingType">Financing Type *</label>
          <select id="participationFinancingType" class="form-input" required>
            <option value="">-- Select --</option>
            <option value="Construction">Construction</option>
            <option value="Permanent">Permanent Financing</option>
          </select>
        </div>
        <div class="form-group">
          <label for="participationPaidOff">Paid Off</label>
          <select id="participationPaidOff" class="form-input">
            <option value="false">No</option>
            <option value="true">Yes</option>
          </select>
        </div>
        <div class="modal-actions">
          <button type="submit" class="btn">Save Participation</button>
          <button type="button" id="cancelParticipationModalBtn" class="btn btn-secondary">Cancel</button>
        </div>
      </form>
    </div>
  </div>

  <!-- Login Modal -->
  <div id="loginModal" class="modal" style="display: none;">
    <div class="modal-content" style="max-width: 400px;">
      <h3>Login Required</h3>
      <p style="margin-bottom: 20px; color: var(--text-secondary);">Please login to enable edit mode</p>
      <form id="loginForm">
        <div class="form-group">
          <label for="loginUsername">Username/Email *</label>
          <input type="text" id="loginUsername" class="form-input" required placeholder="Enter username or email" autocomplete="username" />
        </div>
        <div class="form-group">
          <label for="loginPassword">Password *</label>
          <input type="password" id="loginPassword" class="form-input" required placeholder="Enter password" autocomplete="current-password" />
        </div>
        <div id="loginError" style="color: #dc3545; margin-bottom: 16px; display: none;"></div>
        <div class="modal-actions">
          <button type="submit" class="btn">Login</button>
          <button type="button" id="cancelLoginBtn" class="btn btn-secondary">Cancel</button>
        </div>
      </form>
    </div>
  </div>

  <!-- Add/Edit Region Modal -->
  <div id="addRegionModal" class="modal" style="display: none;">
    <div class="modal-content" style="max-width: 500px;">
      <h3 id="regionModalTitle">Add Region</h3>
      <form id="regionForm">
        <input type="hidden" id="regionId" />
        <div class="form-group">
          <label for="regionName">Region Name *</label>
          <input type="text" id="regionName" class="form-input" required placeholder="e.g., Gulf Coast" />
        </div>
        <div class="form-group">
          <label for="regionDisplayOrder">Display Order</label>
          <input type="number" id="regionDisplayOrder" class="form-input" placeholder="Optional" />
        </div>
        <div class="form-group">
          <label for="regionNotes">Notes</label>
          <textarea id="regionNotes" class="form-input" rows="3" placeholder="Optional notes"></textarea>
        </div>
        <div class="modal-actions">
          <button type="submit" class="btn">Save Region</button>
          <button type="button" id="cancelRegionModalBtn" class="btn btn-secondary">Cancel</button>
        </div>
      </form>
    </div>
  </div>

  <!-- Add/Edit Product Type Modal -->
  <div id="addProductTypeModal" class="modal" style="display: none;">
    <div class="modal-content" style="max-width: 500px;">
      <h3 id="productTypeModalTitle">Add Product Type</h3>
      <form id="productTypeForm">
        <input type="hidden" id="productTypeId" />
        <div class="form-group">
          <label for="productTypeName">Product Type Name *</label>
          <input type="text" id="productTypeName" class="form-input" required placeholder="e.g., Prototype" />
        </div>
        <div class="form-group">
          <label for="productTypeDisplayOrder">Display Order</label>
          <input type="number" id="productTypeDisplayOrder" class="form-input" placeholder="Optional" />
        </div>
        <div class="form-group">
          <label for="productTypeNotes">Notes</label>
          <textarea id="productTypeNotes" class="form-input" rows="3" placeholder="Optional notes"></textarea>
        </div>
        <div class="modal-actions">
          <button type="submit" class="btn">Save Product Type</button>
          <button type="button" id="cancelProductTypeModalBtn" class="btn btn-secondary">Cancel</button>
        </div>
      </form>
    </div>
  </div>

  <!-- Delete Deal Confirmation Modal -->
  <div id="deleteDealModal" class="modal" style="display: none;">
    <div class="modal-content" style="max-width: 500px;">
      <h3 style="color: #c85d5d;">⚠️ Delete Deal</h3>
      <p id="deleteDealMessage" style="margin-bottom: 16px; font-weight: 500;"></p>
      <p style="color: #c85d5d; margin-bottom: 16px; font-size: 0.9em;">
        <strong>WARNING:</strong> This will permanently delete this deal and all associated data. This action CANNOT be undone.
      </p>
      <div class="form-group">
        <label for="deleteConfirmInput" style="font-weight: 600;">Type <strong style="color: #c85d5d;">DELETE</strong> to confirm:</label>
        <input type="text" id="deleteConfirmInput" class="form-input" placeholder="Type DELETE here" autocomplete="off" style="text-transform: uppercase;" />
      </div>
      <div class="modal-actions">
        <button type="button" id="confirmDeleteDealBtn" class="btn" style="background: #c85d5d; color: white;" disabled>Delete Deal</button>
        <button type="button" id="cancelDeleteDealBtn" class="btn btn-secondary">Cancel</button>
      </div>
    </div>
  </div>

  <!-- Add Deal Modal -->
  <div id="addDealModal" class="modal" style="display: none;">
    <div class="modal-content" style="max-width: 600px;">
      <h3>Add New Deal</h3>
      <form id="addDealForm">
        <div class="form-group">
          <label for="newDealProjectName">Project Name *</label>
          <input type="text" id="newDealProjectName" class="form-input" required placeholder="e.g., The Heights at..." />
        </div>
        <div class="form-group">
          <label for="newDealCity">City</label>
          <input type="text" id="newDealCity" class="form-input" placeholder="e.g., Baton Rouge" />
        </div>
        <div class="form-group">
          <label for="newDealState">State</label>
          <input type="text" id="newDealState" class="form-input" placeholder="e.g., LA" maxlength="2" />
        </div>
        <div class="form-group">
          <label for="newDealRegion">Region</label>
          <select id="newDealRegion" class="form-input">
            <option value="">-- Select Region --</option>
          </select>
        </div>
        <div class="form-group">
          <label for="newDealUnits">Units</label>
          <input type="number" id="newDealUnits" class="form-input" placeholder="e.g., 240" />
        </div>
        <div class="form-group">
          <label for="newDealProductType">Product Type</label>
          <select id="newDealProductType" class="form-input">
            <option value="">-- Select Product Type --</option>
          </select>
        </div>
        <div class="form-group">
          <label for="newDealStage">Stage</label>
          <select id="newDealStage" class="form-input">
            <option value="">-- Select Stage --</option>
            <option value="Prospective">Prospective</option>
            <option value="Under Contract">Under Contract</option>
            <option value="Under Construction">Under Construction</option>
            <option value="Lease-Up">Lease-Up</option>
            <option value="Stabilized">Stabilized</option>
            <option value="Liquidated">Liquidated</option>
            <option value="Other">Other</option>
            <option value="Dead">Dead</option>
          </select>
        </div>
        <div class="modal-actions">
          <button type="submit" class="btn">Add Deal</button>
          <button type="button" id="cancelAddDealModalBtn" class="btn btn-secondary">Cancel</button>
        </div>
      </form>
    </div>
  </div>

  <!-- Success Message Toast -->
  <div id="successToast" class="success-toast" style="display: none;">
    <div class="success-toast-content">
      <svg width="20" height="20" viewBox="0 0 20 20" fill="none" style="margin-right: 12px;">
        <path d="M10 0C4.48 0 0 4.48 0 10s4.48 10 10 10 10-4.48 10-10S15.52 0 10 0zm4.64 7.64l-5.5 5.5c-.39.39-1.02.39-1.41 0l-3-3c-.39-.39-.39-1.02 0-1.41.39-.39 1.02-.39 1.41 0L9 10.59l4.64-4.64c.39-.39 1.02-.39 1.41 0 .39.39.39 1.02 0 1.41z" fill="currentColor"/>
      </svg>
      <span id="successToastMessage"></span>
    </div>
  </div>

  <!-- Add New Contact Modal -->
  <div id="addNewContactModal" class="modal" style="display: none;">
    <div class="modal-content" style="max-width: 500px;">
      <h3>Add New Contact</h3>
      <form id="addNewContactForm">
        <div class="form-group">
          <label for="newContactName">Contact Name *</label>
          <input type="text" id="newContactName" class="form-input" required placeholder="e.g., John Doe" />
        </div>
        <div class="form-group">
          <label for="newContactEmail">Contact Email</label>
          <input type="email" id="newContactEmail" class="form-input" placeholder="e.g., john@abccapital.com" />
        </div>
        <div class="form-group">
          <label for="newContactPhone">Contact Phone</label>
          <input type="tel" id="newContactPhone" class="form-input" placeholder="e.g., 555-1234" />
        </div>
        <div class="modal-actions">
          <button type="submit" class="btn">Create Contact</button>
          <button type="button" id="cancelNewContactModalBtn" class="btn btn-secondary">Cancel</button>
        </div>
      </form>
    </div>
  </div>

  <!-- Manage Related Parties Modal -->
  <div id="manageRelatedPartiesModal" class="modal" style="display: none;">
    <div class="modal-content" style="max-width: 700px;">
      <h3 id="manageRelatedPartiesTitle">Manage Related Parties</h3>
      <form id="manageRelatedPartiesForm">
        <input type="hidden" id="manageRelatedPartiesPartnerId" />
        <div class="form-group">
          <p id="manageRelatedPartiesDescription">Select related parties to apply to all commitments for this partner.</p>
        </div>
        
        <div class="form-group">
          <label for="manageRelatedPartiesSearch">Related Parties</label>
          <div class="searchable-select-multi">
            <input type="text" id="manageRelatedPartiesSearch" class="form-input" placeholder="Search for related parties..." autocomplete="off" />
            <div id="manageRelatedPartiesDropdown" class="searchable-dropdown" style="display: none; max-height: 200px; overflow-y: auto;"></div>
            <div id="manageRelatedPartiesChips" class="chips-container" style="margin-top: 8px; display: flex; flex-wrap: wrap; gap: 8px;"></div>
            <select id="manageRelatedParties" class="form-input" multiple style="display: none;"></select>
          </div>
          <small style="color: var(--muted); display: block; margin-top: 4px;">Select other investors involved in commitments for this partner</small>
        </div>
        
        <div class="form-group">
          <label>
            <input type="checkbox" id="applyToAllCommitments" checked />
            Apply to all existing commitments for this partner
          </label>
        </div>
        
        <div class="modal-actions">
          <button type="submit" class="btn">Save Changes</button>
          <button type="button" id="cancelManageRelatedPartiesBtn" class="btn btn-secondary">Cancel</button>
        </div>
      </form>
    </div>
  </div>

  <!-- Bulk Edit Modal -->
  <div id="bulkEditEquityTypeModal" class="modal" style="display: none;">
    <div class="modal-content" style="max-width: 600px;">
      <h3>Bulk Edit</h3>
      <form id="bulkEditEquityTypeForm">
        <div class="form-group">
          <label>Edit <span id="bulkEditCommitmentCount">0</span> commitment(s)</label>
        </div>
        <div class="form-group">
          <label for="bulkEditFieldSelect">What to Edit *</label>
          <select id="bulkEditFieldSelect" class="form-input" required>
            <option value="">-- Select Field --</option>
            <option value="equityType">Equity Type</option>
            <option value="relatedParties">Related Parties</option>
          </select>
        </div>
        
        <!-- Equity Type Fields -->
        <div id="bulkEditEquityTypeFields" class="form-group" style="display: none;">
          <label for="bulkEditEquityTypeSelect">Select Equity Type *</label>
          <select id="bulkEditEquityTypeSelect" class="form-input">
            <option value="">-- Select Type --</option>
            <option value="Pref">Pref</option>
            <option value="Common">Common</option>
            <option value="Profits Interest">Profits Interest</option>
            <option value="Stoa Loan">Stoa Loan</option>
            <option value="Other">Other</option>
          </select>
        </div>
        
        <!-- Related Parties Fields -->
        <div id="bulkEditRelatedPartiesFields" class="form-group" style="display: none;">
          <label for="bulkEditRelatedParties">Related Parties</label>
          <div id="bulkEditRelatedPartiesContainer" class="searchable-select">
            <div id="bulkEditRelatedPartiesChips" style="display: flex; flex-wrap: wrap; gap: 6px; margin-bottom: 8px; min-height: 32px;">
              <!-- Selected items will appear as chips here -->
            </div>
            <input type="text" id="bulkEditRelatedPartiesSearch" class="form-input" placeholder="Search for related parties..." autocomplete="off" />
            <select id="bulkEditRelatedParties" class="form-input" multiple style="display: none;">
              <!-- Hidden select for form submission -->
            </select>
            <div id="bulkEditRelatedPartiesDropdown" class="searchable-dropdown" style="display: none; max-height: 200px; overflow-y: auto;"></div>
            <small style="color: var(--muted); display: block; margin-top: 4px;">Select other investors involved in these commitments (not the lead)</small>
          </div>
        </div>
        
        <div class="modal-actions">
          <button type="submit" class="btn">Update</button>
          <button type="button" id="cancelBulkEditModalBtn" class="btn btn-secondary">Cancel</button>
        </div>
      </form>
    </div>
  </div>

  <!-- domo.js from ryuu.js - required for Domo data access -->
  <script src="https://unpkg.com/ryuu.js@4.6.0/dist/domo.js" integrity="sha384-YYsd9wQ+wDlUWhvpfGdptxmNYIqBC+52oJtWgPKJadbs3sSFTY/+ZotPbEHTTRWz" crossorigin="anonymous"></script>
  <script src="api-client.js"></script>
  <script src="app.js"></script>
</body>
</html>
